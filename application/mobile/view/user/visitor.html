<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>来访者</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!-- jquery-weui-css -->
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/weui.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/js/js-plugins/jquery-weui-build/jquery-weui.min.css">
    <!-- 页面-css -->
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/wode-common.css">
    <script type="text/javascript">
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
</head>

<body class="visitors-page">
    <header>
        <a href="javascript:void(0)" class="back"></a>
        <div class="title">
            <a href="javascript:void(0)" data-list="visiList" class="actived">来访者</a>
            <a href="javascript:void(0)" data-list="seenList">我看过的人</a>
        </div>
    </header>

    <div class="comments-content">
        <div class="weui-pull-to-refresh__layer">
            <div class='weui-pull-to-refresh__arrow'></div>
            <div class='weui-pull-to-refresh__preloader'></div>
            <div class="down">下拉刷新</div>
            <div class="up">释放刷新</div>
            <div class="refresh">正在刷新</div>
        </div>


        <ul class="visiList">
        </ul>

        <ul class="seenList" style="display: none;">
        </ul>

        <div class="noComments" style="display: none;">
            <img src="__STATIC__/images/icon/暂无要找内容.png">
            <p>暂无任何内容</p>
        </div>


        <div class="weui-loadmore" style="display: none;">
            <i class="weui-loading"></i>
            <span class="weui-loadmore__tips">正在加载</span>
        </div>
    </div>


    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <!-- jquery-weui-js -->
    <script type="text/javascript" src="__STATIC__/js/js-plugins/jquery-weui-build/jquery-weui.min.js"></script>
    <script>
        var GlobalHost = "http://meiliyue.caapa.org";
        var Visitors={
            user_id:"",

            curList:"visiList",
            isScroll:false,
            loading:false,

            visiList:{
                haveLoad:false,
                page:1,
            },
            seenList:{
                haveLoad:false,
                page:1,
            },
            

            updateDom:function(data){
                let $curUl=$("."+Visitors.curList);
                if(data&&data.length!==0){
                    if(!Visitors.isScroll){
                        $curUl.html("");
                    }
                    data.forEach(function(item,index){
                        let timeStr=stampToStr(item.add_time);
                        let $li=$(`
                            <li class="comments-item" data-toUserId=${item.user_id}>
                                <div class="comments-avatar">
                                    <div class="comments-avatar-wrap">
                                        <img src="${GlobalHost+item.head_pic}">
                                    </div>
                                    <span class="videoStatus" style="display:none;"></span>
                                </div>

                                <div class="comments-text">
                                    <div>
                                        <span class="listName">${item.nickname}</span>
                                        <span class="sexAge">
                                            <i class="sex"></i>
                                            <span class="age">${item.age}</span>
                                        </span>
                                    </div>
                                    <span class="">${timeStr}</span>
                                    <p class="signature">${item.signature}</p>
                                </div>

                                <img class="visitors-isnew" style="display:none;" src="__STATIC__/images/icon/火.png">
                            </li>
                        `);
                        //视频认证
                        if(item.auth_video_status==1){
                            $li.find(".videoStatus").show();
                        }
                        // $li.find(".videoStatus").show();//测试用
                        //sex
                        if(item.sex==1){
                            $li.find(".sexAge").addClass("male");
                        }else{
                            $li.find(".sexAge").addClass("female");
                        }

                        $curUl.append($li);

                    });
                }else{
                    if(Visitors[Visitors.curList].page!==1){
                        //无内容
                        $(".noComments").show();
                    }
                }
                
                //updateDom后
                //滚动加载的"正在加载"是否显示
                if($curUl[0].scrollHeight>($(".visitors-page").height()-50)){
                    $(".weui-loadmore").show();
                }

                //绑定dom update后才能绑定的事件？
                // Visitors.eventsBindAfter();

            },
            getVideoUrl:function(user_id,callback){//user_id
                $.ajax({
                    type: "POST",
                    url: GlobalHost+"/index.php/Api/user/getAuthVideoUrl",
                    data: {
                        user_id:user_id
                    },
                    dataType: "json",
                    success: function (result) {
                        console.log(result)
                        if(result.code==200){//测试用
                            let url=GlobalHost+result.data.video_url;
                            callback(url);
                        }
                    }
                });
            },
            showVideo:function({user_id,head_pic,src}){
                console.log(user_id,head_pic,src)
                let $fullScreen=$(`
                    <div class="fullScreen">
                        <div class="videoHeader">
                            <div class="closeFullScreen"></div>
                            <div class="videoOperate"></div>
                            <div class="img-box">
                                <img src=${head_pic}>
                            </div>
                        </div>

                        <div class="fullScreenScroll">
                            <div class="fullScreenWrap">
                                <span class="progressBar"></span>
                                <video id="video1" width="100%" height="100%" src=${src} autoplay loop></video>
                                <div class="videoFooter">
                                    <div class="videoCommentBtn"></div>
                                    <span class="littleTri"></span>
                                </div>
                            </div>
                            <!-- 小视频评论 -->
                            <div class="" style="height: 300px;background-color: red;;">

                            </div>
                            
                            <!-- 小视频评论input -->
                            <div class="videoInput">
                                <input type="text">
                                <span class="sendComment">发送</span>
                            </div>
                        </div>
                    </div>
                `);

                //点击关闭事件
                $fullScreen.find(".closeFullScreen").click(function(){
                    $fullScreen.remove();
                });
                
                $("body").append($fullScreen);
            },
            getListData:function(){
                let getPage;
                if(Visitors.isScroll){
                    getPage=Visitors[Visitors.curList].page+1;
                }else{
                    getPage=1;
                }
                let postData={
                    user_id:Visitors.user_id,
                    type:Visitors.curList=="visiList"?1:2,
                    page:getPage,
                };
                console.log(postData)
                $.ajax({
                    type: "POST",
                    url: GlobalHost+"/index.php/api/user/visitor",
                    data: postData,
                    dataType: "json",
                    success: function (result) {
                        console.log(result.data)
                        // result.data=result.data.concat(result.data).concat(result.data).concat(result.data).concat(result.data).concat(result.data).concat(result.data).concat(result.data).concat(result.data).concat(result.data);//测试用
                        // result.data=[];//测试用

                        if(Visitors.isScroll){
                            if(result.data.length!==0){
                                Visitors[Visitors.curList].page++;
                            }
                            Visitors.isScroll=false;
                        }

                        Visitors.updateDom(result.data)
                        
                        Visitors[Visitors.curList].haveLoad=true;

                        //下拉刷新done 滚动加载done
                        $(".comments-content").pullToRefreshDone();
                        Visitors.loading=false;
                    }
                });
            },
            initPullToRefresh:function(){
                //下拉刷新
                $(".comments-content").pullToRefresh(function () {
                    Visitors.getListData();
                });
                //滚动加载
                $(".comments-content").infinite().on("infinite", function() {
                    Visitors.isScroll=true;
                    //原
                    if(Visitors.loading) return;
                    Visitors.loading = true;
                    Visitors.getListData();
                });
                //点击li去他人的主页
                $(".visitors-page .comments-content>ul").delegate("li","click",function(){
                    //save?

                    let user_id=Visitors.user_id;
                    let toUserId=$(this).attr("data-toUserId");
                    window.location.href = GlobalHost + "/index.php/mobile/user/homePage/user_id/"+user_id+"/toUserId/"+toUserId+".html";
                });
            },
            eventsBind:function(){
                //back
                $(".back").click(function(){
                    window.history.back(-1);
                });
                //切换tab
                $(".visitors-page>header .title a").click(function(){
                    $(this).addClass("actived").siblings().removeClass("actived");

                    let className=$(this).attr("data-list");
                    console.log(className)
                    $("."+className).show().siblings("ul").hide();

                    Visitors.curList=className;

                    //切换时，如果没加载就加载
                    if(!Visitors[Visitors.curList].haveLoad){
                        Visitors.getListData();
                    }
                });
                //点击视频认证
                $(".visiList")
                .add($(".seenList")).delegate(".videoStatus","click",function(event){
                    event.stopPropagation();
                    let toUserId=Number($(this).closest(".comments-item").attr("data-toUserId"));
                    let head_pic=$(this).closest(".comments-avatar").find("img").attr("src");
                    console.log(head_pic)
                    Visitors.getVideoUrl(toUserId,function(url){
                        // url="https://media.w3.org/2010/05/sintel/trailer.mp4";//测试用
                        Visitors.showVideo({
                            user_id:toUserId,
                            head_pic:head_pic,
                            src:url
                        });
                    });
                });
            },
            init:function(){
                //我的user_id
                Visitors.user_id=1;

                Visitors.initPullToRefresh();

                Visitors.getListData();

                Visitors.eventsBind();
            }
        };
        $(function () {
            Visitors.init();
        });
        //时间戳转日期时间
        function stampToDate(timestamp) {
            var date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
            Y = date.getFullYear() + '-';
            M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            D = (date.getDate()<10?"0"+date.getDate():date.getDate()) + ' ';
            h = (date.getHours()<10?"0"+date.getHours():date.getHours()) + ':';
            m = (date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes());
            // s = date.getSeconds();
            return Y+M+D+h+m;
        }
        //时间戳转文字
        function stampToStr (stamp) {//传来的stamp十位数
            if (!stamp) return '';

            let nowStamp=Math.round((new Date().getTime())/1000);
            let howLong=nowStamp-stamp;

            if(howLong<60){//1分钟内
                return "1分钟内";
            }else if(howLong<3600){//1小时内，显示分钟数
                let minutes=Math.floor(howLong/60);
                return minutes+"分钟前";
            }else if(howLong<43200){//12小时内，显示小时数
                let hours=Math.floor(howLong/3600);
                return hours+"小时前";
            }else if(howLong>=43200&&howLong<86400){//大于12小时，小于24小时
                let dateStr=stampToDate(stamp);
                console.log(dateStr)
                let minStr=dateStr.substr(dateStr.length-5);
                return "昨天 "+minStr;
            }else if(howLong>86400){//大于24小时，直接显示时间
                return stampToDate(stamp);
            }
        }
    </script>
</body>

</html>