<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>发动态</title>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/dongtai-common.css">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <script type="text/javascript">
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <!-- 表情插件 -->
    <link rel="stylesheet" href="__STATIC__/js/js-plugins/jQuery-emoji-master20160321/lib/css/jquery.mCustomScrollbar.min.css">
    <link rel="stylesheet" href="__STATIC__/js/js-plugins/jQuery-emoji-master20160321/dist/css/jquery.emoji.css">
    <script src="__STATIC__/js/js-plugins/jQuery-emoji-master20160321/lib/script/jquery.mCustomScrollbar.min.js"></script>
    <script src="__STATIC__/js/js-plugins/jQuery-emoji-master20160321/dist/js/jquery.emoji.min.js"></script>
</head>

<body class="edit">
    <header>
        <div class="cancel">取消</div>
        <div class="title">发动态</div>
        <div class="save">确定</div>
    </header>

    <div class="edit-page">
        <div class="edit-content">
            <!-- <textarea name="" id="edit-text" placeholder="此刻你在想什么......"></textarea> -->
            <div id="edit-text" contenteditable="true">
                <!-- <img class="emoji_icon" src="__STATIC__/js/js-plugins/jQuery-emoji-master20160321/dist/img/tieba/14.jpg"> -->
            </div>
            <div class="edit-expression">
                <!-- <span class="face"></span> -->
                <span class="textCount">
                    <span id="textCount">0</span>/1000</span>
            </div>
        </div>

        <div class="edit-pic">
            <ul>
                <li class="edit-pic-item">
                    <img src="__STATIC__/images/icon/tx.png" alt="">
                    <a href="javascript:void(0)" class="edit-closePic"></a>
                </li>
                <li class="edit-pic-item">
                    <img src="__STATIC__/images/icon/tx.png" alt="">
                    <a href="javascript:void(0)" class="edit-closePic"></a>
                </li>
            </ul>
            <a href="javascript:void(0)" class="">
                <img src="__STATIC__/images/icon/add.png" alt="">
            </a>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="confirmDelete" style="display: none;">
        <p>
            你尚未发布，确认删除？
        </p>
        <div class="confirmDelete-btngroup">
            <a href="javascript:void(0)" class="cancelDelete">取消</a>
            <a href="javascript:void(0)" class="delete">确定</a>
        </div>
    </div>

</body>

<script>
    var Edit = {
        _user_id: "123",

        //取消照片
        cancelPic: function (el) { //pic的a标签
            $('body').append($('<div class="mask"></div>'))
            $('.confirmDelete').show()

            //取消删除
            $(".cancelDelete").click(function () {
                $('.mask').remove()
                $('.confirmDelete').hide()
            })
            //确认删除
            $(".delete").click(function () {
                $('.mask').remove()
                $('.confirmDelete').hide()

                $(el).closest('.edit-pic-item').remove()
            })
        },
        //生成表情插件
        generateFace: function () {
            $("#edit-text").emoji({
                showTab: false,
                animation: 'fade',
                icons: [{
                    name: "贴吧表情",
                    path: "__STATIC__/js/js-plugins/jQuery-emoji-master20160321/dist/img/tieba/",
                    maxNum: 50,
                    file: ".jpg",
                    placeholder: ":{alias}:",
                    alias: {
                        1: "hehe",
                        2: "haha",
                        3: "tushe",
                        4: "a",
                        5: "ku",
                        6: "lu",
                        7: "kaixin",
                        8: "han",
                        9: "lei",
                        10: "heixian",
                        11: "bishi",
                        12: "bugaoxing",
                        13: "zhenbang",
                        14: "qian",
                        15: "yiwen",
                        16: "yinxian",
                        17: "tu",
                        18: "yi",
                        19: "weiqu",
                        20: "huaxin",
                        21: "hu",
                        22: "xiaonian",
                        23: "neng",
                        24: "taikaixin",
                        25: "huaji",
                        26: "mianqiang",
                        27: "kuanghan",
                        28: "guai",
                        29: "shuijiao",
                        30: "jinku",
                        31: "shengqi",
                        32: "jinya",
                        33: "pen",
                        34: "aixin",
                        35: "xinsui",
                        36: "meigui",
                        37: "liwu",
                        38: "caihong",
                        39: "xxyl",
                        40: "taiyang",
                        41: "qianbi",
                        42: "dnegpao",
                        43: "chabei",
                        44: "dangao",
                        45: "yinyue",
                        46: "haha2",
                        47: "shenli",
                        48: "damuzhi",
                        49: "ruo",
                        50: "OK"
                    },
                    title: {
                        1: "呵呵",
                        2: "哈哈",
                        3: "吐舌",
                        4: "啊",
                        5: "酷",
                        6: "怒",
                        7: "开心",
                        8: "汗",
                        9: "泪",
                        10: "黑线",
                        11: "鄙视",
                        12: "不高兴",
                        13: "真棒",
                        14: "钱",
                        15: "疑问",
                        16: "阴脸",
                        17: "吐",
                        18: "咦",
                        19: "委屈",
                        20: "花心",
                        21: "呼~",
                        22: "笑脸",
                        23: "冷",
                        24: "太开心",
                        25: "滑稽",
                        26: "勉强",
                        27: "狂汗",
                        28: "乖",
                        29: "睡觉",
                        30: "惊哭",
                        31: "生气",
                        32: "惊讶",
                        33: "喷",
                        34: "爱心",
                        35: "心碎",
                        36: "玫瑰",
                        37: "礼物",
                        38: "彩虹",
                        39: "星星月亮",
                        40: "太阳",
                        41: "钱币",
                        42: "灯泡",
                        43: "茶杯",
                        44: "蛋糕",
                        45: "音乐",
                        46: "haha",
                        47: "胜利",
                        48: "大拇指",
                        49: "弱",
                        50: "OK"
                    }
                }]
            });
        },
        //获取地理位置
        getAddress: function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    alert(lat, lon)
                    // //var map = new BMap.Map("container");   // 创建Map实例
                    // var point = new BMap.Point(lon, lat); // 创建点坐标
                    // var gc = new BMap.Geocoder();
                    // gc.getLocation(point, function (rs) {
                    //     var addComp = rs.addressComponents;
                    //     var curCity = {
                    //         id: '',
                    //         name: addComp.province,
                    //         date: curDateTime()
                    //     };
                    //     //当前定位城市
                    //     $.cookie('VPIAO_MOBILE_CURRENTCITY', JSON.stringify(curCity), {
                    //         expires: 7,
                    //         path: '/'
                    //     });
                    //     //alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street);
                    //     if (successFunc != undefined)
                    //         successFunc(addComp);
                    // });
                })
            }
        },
        //发动态
        sendDynamic: function () {
            var contentStr = document.getElementById("edit-text").innerHTML.trim()
            console.log(contentStr)

            // var saveContentStr = contentStr.replace(/<img class=\"emoji_icon\" src=\"([^>]*)\">/g, "$1");
            // // __STATIC__/js/js-plugins/jQuery-emoji-master20160321/dist/img/tieba/14.jpg"
            // // str.replace(/<img[^>]*>/g, "[图片]");

            var postData = {
                // user_id: Edit._user_id,
                type: "1", //1文字2图片3视频
                content: contentStr,
                // location: "",
                // visible: "1" //1公开2好友3仅自己
                // image:"",
                // video:""
            }
            // $.ajax({
            //     type: "POST",
            //     url: "http://meiliyue.caapa.org/index.php/Api/Dynamics/add",
            //     data: postData,
            //     dataType: "json",
            //     success: function (result) {
            //         console.log(result)
            //     }
            // })
        },
        //限制字数
        bindLimitCount: function () {
            var textarea = document.getElementById('edit-text')
            textarea.onchange = function () {
                limitCount(this)
            }
            textarea.onkeydown = function () {
                limitCount(this)
            }
            textarea.onkeyup = function () {
                limitCount(this)
            }

            function limitCount(el) {
                let vInnerHtml = el.innerHTML.replace(/<img[^>]*>/g, "图").trim()
                // el.value = el.value.substring(0, 1000)
                let count = vInnerHtml.length
                document.getElementById('textCount').innerHTML = count
                if (count >= 1000) {
                    alert("最多输入1000个字符")
                }
            }
        },
        eventsBind: function () {
            //限制字数
            Edit.bindLimitCount()
            //发动态
            $(".save").click(function () {
                Edit.sendDynamic()
            })
            //取消照片
            $(".edit-pic-item .edit-closePic").click(function () {
                Edit.cancelPic(this)
            })
        },
        init: function () {
            //获取页面参数
            var strTemp = "?user_id=123"
            //表情插件
            Edit.generateFace()

            Edit.eventsBind()
        }
    }
    $(function () {
        Edit.init()
    })
</script>

</html>