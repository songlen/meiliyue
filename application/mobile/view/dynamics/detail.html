<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>详情</title>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/dongtai-common.css">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <script type="text/javascript">
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="__STATIC__/js/vue.js"></script>
</head>

<body class="details">
    <div class="vueWrap" id="vueApp">
        <header>
            <a href="javascript:window.history.back(-1)" class="back"></a>
            <div class="title">详情</div>
            <a href="javascript:void(0)" class="operate"></a>
        </header>

        <div class="details-page">
            <div class="details-content">
                <div class="details-content-head">
                    <img src="{$info.head_pic}" alt="">
                    <div class="details-content-head-text">
                        <div>
                            <span>{$info.nickname}</span>
                            <span class='sexAge <if condition="$info.sex eq 1">male<else />female</if>'>
                                <i class="sex"></i>
                                <span class="age">{$info.age}</span>
                            </span>
                            <!-- <span class="topping">置顶</span> -->
                        </div>
                        <span>{$info.time}</span>
                    </div>
                </div>
                <div class="details-content-text">
                    <p>
                        {$info.content}
                    </p>
                    <if condition="$item['type'] == 2 && !empty($item['image'])">
                        <foreach name="$item.image" item="image">
                        <img src="{$image}" alt="">
                        </foreach>
                    </if>
                </div>
                <div class="details-flower">
                    <div class="giveFlower">
                        <img class="noFlower" src="__STATIC__/images/icon/花1.png">
                        <img class="haveFlower" src="__STATIC__/images/icon/花2.png" style="display: none;">
                    </div>
                    <span class="flowerCount">{$info.flower_num}</span>
                </div>
            </div>

            <div class="flowerPool">
                <if condition="$info.flower_num gt 0">
                <for start="0" end="$info.flower_num">
                <div class="flowerItem">
                    <img src="__STATIC__/images/icon/花3.png" alt="">
                </div>
                </for>
                </if>
                <if condition="$info.flower_num gt 99">
                <span class="flowerPool-count">99+</span>
                </if>
            </div>

            <div class="audience">
                <ul>
                    <if condition="is_array($viewers) && !empty($viewers)">
                    <foreach name="$viewers" item="viewer">
                    <li>
                        <img src="{$viewer.head_pic}" alt="">
                    </li>
                    </foreach>
                    </if>
                </ul>
            </div>

            <!-- 评论列表 -->

            <div class="details-comments">
                <div class="details-comments-head" style="display: none;">
                    <img src="__STATIC__/images/icon/消息.png">评论&nbsp;（为保护隐私，评论头像和昵称都是随机生成）
                </div>
                <ul>
                    <li class="details-comments-item" v-cloak v-for="(item,index) in commentsList" :key="index">
                        <div class="comment-headWrap" @click="applyHomepage">
                            <img :src="'http://meiliyue.caapa.org'+item.head_pic" @error="defaultImg">
                            <!-- <img v-cloak v-else src="__STATIC__/images/icon/tx.png"> -->
                        </div>
                        <div class="details-comments-content">
                            <div class="details-item-head">
                                <span class="nickname">{{item.nickname}}</span>
                                <span class="detailsTime">{{item.add_time}}</span>
                            </div>
                            <div class="details-comments-text" @click="startComment(1,item)">{{item.content}}</div>

                            <!-- 二级评论 -->
                            <div class="details-comments-content-second" v-cloak v-if="item.sub&&item.sub.length!==0">
                                <ul class="comments-second-ul">
                                    <li v-cloak v-for="(subItem,subIndex) in item.sub" :key="subIndex">
                                        <div class="details-item-head">
                                            <span class="nickname">{{subItem.nickname}}</span>
                                            <span class="detailsTime">{{subItem.add_time}}</span>
                                        </div>
                                        <div class="details-comments-text">
                                            <span class="replyWrap">回复
                                                <span class="replyPerson">{{subItem.reply_nickname}}</span>：</span>
                                            <span class="details-second-text" @click="startComment(1,subItem)">{{subItem.content}}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </li>
                </ul>
            </div>

            <!-- 评论列表 end -->

            <div class="details-tip">
                <img src="__STATIC__/images/icon/tx.png">评论所有人可见，悄悄话仅对方和你可见
            </div>
        </div>

        <div class="details-input">
            <a href="javascript:void(0)" style="display: none;">悄悄话</a>
            <input class="details-realInput" type="text" v-model="inputComment" :placeholder="placeHolder">
            <span class="details-face" style="display: none;"></span>
            <span class="sendComment" @click="sendComment">发送</span>
        </div>


        <!-- 模态框 -->

        <!-- 送小花提示窗 -->
        <div class="flowerDialog" style="display: none;">
            <p>
                您已成功送给对方
                <span class="sendSuccessCount">1</span>朵小花，剩余小花
                <span class="dialogLeftFlowers">99</span>朵
            </p>
            <span class="littleFlower"></span>
        </div>
        <!-- 申请查看主页提示窗 -->
        <div class="avatarOperating" style="display: none;">
            <ul>
                <li class="">申请查看TA的主页</li>
                <li class="home-cancel">取消</li>
            </ul>
        </div>
        <!-- 更多操作提示窗 -->
        <div class="avatarOperating-jubao" style="display: none;">
            <ul>
                <li class="">举报</li>
                <li class="jubao-cancel">取消</li>
            </ul>
        </div>

    </div>
</body>

<script>
    var Details = {
        _flowerTimer: null,
        replyDiv: null,
        commentType: 1, //1给动态评论  2二级评论

        //送花
        giveFlower: function () {
            //用户id  动态id
            var postData = {
                user_id: "123",
                dynamics_id: "12"
            }

            return

            $.ajax({
                type: "POST",
                url: "http://meiliyue.caapa.org/index.php/Api/Dynamics/giveFlower",
                data: postData,
                dataType: "json",
                success: function (result) {
                    //这里需要更多信息？？
                    let sendedFlowersCount = 2 //已送2朵小花
                    let leftFlowersCount = 99 //自己剩余99朵小花
                    if (result.msg == "操作成功") {
                        //显示提示弹窗
                        $(".flowerDialog .sendSuccessCount").text(sendedFlowersCount)
                        $(".flowerDialog .dialogLeftFlowers").text(leftFlowersCount)
                        $(".flowerDialog").show().addClass('mfadeout')
                        clearTimeout(Details._flowerTimer)
                        Details._flowerTimer = setTimeout(function () {
                            $('.flowerDialog').hide().removeClass('mfadeout')
                        }, 1300)
                        //显示提示弹窗 end
                        //小花池里增加一朵小花
                        $(".flowerPool").prepend($(
                            '<div class="flowerItem"><img src="../images/icon/花3.png"></div>'
                        ))
                        //小花池数量加一
                        $(".flowerPool-count").html(Number($(".flowerPool-count").html()) + 1)
                        //小花样式
                        if ($(".haveFlower").css("display") == "none") {
                            $(".haveFlower").show()
                            $(".noFlower").hide()
                        }
                        //已有小花数量加一
                        $(".flowerCount").html(Number($(".flowerCount").html()) + 1)
                    }
                }
            })
        },

        //申请查看主页
        applyHomepage: function () {
            console.log(3)
            $('body').append($('<div class="mask"></div>'))
            $('.avatarOperating').show()
            // $('.avatarOperating').show().animate({'bottom':'0'},300)
            $('body').css('overflow', 'hidden')
        },
        initVue: function () {
            var commentsVm = new Vue({
                el: "#vueApp",
                data: {
                    commentsList: [],
                    placeHolder: "输入评论",
                    inputComment: "",
                    replyItem: null,
                },
                beforeMount: function () {
                    this.getCommentsList()
                },
                mounted: function () {
                    Details.eventsBind()
                },
                methods: {
                    //获取评论列表数据
                    getCommentsList: function () {
                        var self = this
                        var postData = {
                            dynamic_id: 1
                        }
                        $.ajax({
                            type: "POST",
                            url: "http://meiliyue.caapa.org/index.php/Api/Dynamics/getComment",
                            data: postData,
                            dataType: "json",
                            success: function (result) {
                                console.log(result.data)
                                self.commentsList = result.data
                            }
                        })
                    },
                    //触发评论 让input focus
                    startComment: function (type, item) { //0点击动态 1点击评论/回复谁
                        // console.log(event)
                        var el = event.target
                        if (false) { //点击的是自己评论的，提问是否删除 //需要和自己的nickname对比？

                        } else if (type == 0) {
                            this.placeHolder = "输入评论"
                            this.replyItem = null
                            $(".details-realInput").focus()

                            //记录点击的评论
                            Details.replyDiv = el
                            Details.commentType = 1
                        } else if (type == 1) {
                            this.placeHolder = "回复" + item.nickname
                            this.replyItem = item
                            $(".details-realInput").focus()

                            //记录点击的评论
                            Details.replyDiv = el
                            Details.commentType = 2
                        }
                    },
                    //发送评论
                    sendComment: function () {
                        console.log(this.replyItem)

                        var self = this
                        var itemIndex //父评论的index

                        if (this.inputComment.trim() == "") {
                            return
                        }

                        if (this.replyItem) {

                            //获取父评论的index
                            if (self.replyItem.parent_id == 0) {
                                itemIndex = self.commentsList.indexOf(self.replyItem)
                            } else { //点的是二级评论
                                self.commentsList.forEach(function (item, index) {
                                    if (item.sub) {
                                        if (item.sub.indexOf(self.replyItem) > -1) {
                                            itemIndex = index
                                            return
                                        }
                                    }
                                })
                            }

                            var postData = {
                                reply_user_id: 11, //这条动态的发布人？
                                dynamic_id: 1,
                                commentator_id: 123, //评论者id

                                parent_id: this.commentsList[itemIndex].comment_id,
                                content: this.inputComment,
                                private: null //悄悄话
                            }
                        } else {
                            //给这条动态评论
                            var postData = {
                                reply_user_id: 11, //这条动态的发布人？
                                dynamic_id: 1,
                                commentator_id: 123, //评论者id

                                parent_id: "0",
                                content: this.inputComment,
                                private: null //悄悄话
                            }
                        }

                        // ---------------------

                        if (self.replyItem) {

                            if (!self.commentsList[itemIndex].sub) {
                                self.commentsList[itemIndex].sub = []
                            }

                            var addItem = {
                                add_time: "122222222",
                                comment_id: "23232",
                                commentator_id: "99",
                                head_pic: "sdfsfsdf",

                                content: self.inputComment,
                                parent_id: self.commentsList[itemIndex].comment_id,

                                nickname: "我自己",
                                reply_nickname: "我自己？"
                            }
                            self.commentsList[itemIndex].sub.push(addItem)
                        } else {
                            var addItem = {
                                add_time: "122222222",
                                comment_id: "23232",
                                commentator_id: "99",
                                head_pic: "sdfsfsdf",

                                content: self.inputComment,
                                parent_id: "0",

                                nickname: "我自己",
                                reply_nickname: "我自己？"
                            }
                            self.commentsList.push(addItem)
                        }

                        //send完评论，重置data
                        self.inputComment = ""
                        self.placeHolder = "输入评论"
                        self.replyItem = null

                        return

                        $.ajax({
                            type: "POST",
                            url: "http://meiliyue.caapa.org/index.php/Api/dynamics/addComment",
                            data: postData,
                            dataType: "json",
                            success: function (result) {
                                //放数据？
                                if (result.msg == "操作成功") {

                                    if (self.replyItem) {

                                        if (!self.commentsList[itemIndex].sub) {
                                            self.commentsList[itemIndex].sub = []
                                        }

                                        var addItem = {
                                            add_time: "122222222",
                                            comment_id: "23232",
                                            commentator_id: "99",
                                            head_pic: "sdfsfsdf",

                                            content: self.inputComment,
                                            parent_id: self.commentsList[itemIndex]
                                                .comment_id,

                                            nickname: "我自己",
                                            reply_nickname: "我自己？"
                                        }
                                        self.commentsList[itemIndex].sub.push(addItem)
                                    }

                                    //send完评论，重置data
                                    self.inputComment = ""
                                    self.placeHolder = "输入评论"
                                    self.replyItem = null

                                    //二级评论
                                    // var $commentDiv = $(Details.replyDiv).closest(
                                    //     ".details-comments-content") //当前这条评论
                                    // var isHaveSecond = $commentDiv.find(
                                    //         ".details-comments-content-second")
                                    //     .length //是否已经有二级评论了
                                    // if (!isHaveSecond) { //还没有二级评论
                                    //     $commentDiv.append($(
                                    //         '<div class="details-comments-content-second"><ul></ul></div>'
                                    //     ))
                                    // }
                                    // //加一条评论div
                                    // $commentDiv.find(
                                    //     ".details-comments-content-second ul").append(
                                    //     $(
                                    //         `
                                    //             <li>
                                    //                 <div class="details-item-head">
                                    //                     <span class="nickname">怕黑的萌物</span>
                                    //                     <span class="detailsTime">2016-12-16 22:55</span>
                                    //                 </div>
                                    //                 <div class="details-comments-text">
                                    //                     <span class="replyWrap">回复
                                    //                         <span class="replyPerson">佟舟</span>：</span>
                                    //                     <span class="details-second-text">可以可以</span>
                                    //                 </div>
                                    //             </li>
                                    //         `
                                    //     ))
                                    // $(".details-realInput").val("").attr("placeholder",
                                    //     "输入评论")
                                    //二级评论 end
                                }
                            }
                        })
                    },
                    //头像加载失败，默认图片
                    defaultImg: function (event) {
                        event.target.src = "../images/icon/tx.png"
                    },
                    applyHomepage: function () {
                        console.log(3)
                        $('body').append($('<div class="mask"></div>'))
                        $('.avatarOperating').show()
                        // $('.avatarOperating').show().animate({'bottom':'0'},300)
                        $('body').css('overflow', 'hidden')
                    }
                }
            })
        },
        eventsBind: function () {
            //点击送花
            $(".giveFlower").click(function () {
                console.log(555)
                Details.giveFlower()
            })
            //点击头像打开个人主页
            $(".details-headImgWrap").click(function () {
                //打开个人主页
            })
            //申请查看主页-取消
            $(".home-cancel").click(function () {
                $('.mask').remove()
                // $('.avatarOperating').animate({'bottom':'-2rem'},300,function(){
                $('.avatarOperating').hide()
                // })
                $('body').css('overflow', 'auto')
            })
            //更多操作 举报
            $(".operate").click(function () {
                $('body').append($('<div class="mask"></div>'))
                $('.avatarOperating-jubao').show()
                // $('.avatarOperating').show().animate({'bottom':'0'},300)
                $('body').css('overflow', 'hidden')
            })
            //更多操作 举报-取消
            $(".jubao-cancel").click(function(){
                $('.mask').remove()
                // $('.avatarOperating').animate({'bottom':'-2rem'},300,function(){
                $('.avatarOperating-jubao').hide()
                // })
                $('body').css('overflow', 'auto')
            })
        },
        init: function () {
            Details.initVue()
            //Details.eventsBind()
        }
    }
    $(function () {
        Details.init()
    })
</script>

</html>