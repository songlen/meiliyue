<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>详情</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/dongtai-common.css">
    <script type="text/javascript">
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
</head>

<body class="details">
    <div class="vueWrap" id="vueApp">
        <header>
            <a href="javascript:window.history.back(-1)" class="back"></a>
            <div class="title">动态详情</div>
            <a href="javascript:void(0)" class="operate"></a>
        </header>
        <div class="details-page">
            <div class="details-content">
                <div class="details-content-head">
                    <div class="details-headImgWrap">
                        <img src="{$info.head_pic}">
                    </div>
                    <div class="details-content-head-text">
                        <div>
                            <span>{$info.nickname}</span>
                            <span class='sexAge <if condition="$info.sex eq 1">male<else />female</if>'>
                                <i class="sex"></i>
                                <span class="age">{$info.age}</span>
                            </span>
                            <span class="topping" style="display: none;">置顶</span>
                        </div>
                        <span>{$info.time}</span>
                    </div>
                </div>
                <div class="details-content-text">
                    <p class="dynamic-text details-comments-text" @click="startComment(0)">
                        {$info.content}
                    </p>
                    <if condition="$item['type'] == 2 && !empty($item['image'])">
                        <foreach name="$item.image" item="image">
                        <img src="{$image}" alt="">
                        </foreach>
                    </if>
                </div>
                <div class="details-flower">
                    <div class="giveFlower">
                        <img class="noFlower" src="__STATIC__/images/icon/花1.png">
                        <img class="haveFlower" src="__STATIC__/images/icon/花2.png" style="display: none;">
                    </div>
                    <span class="flowerCount">{$info.flower_num}</span>
                </div>
            </div>

            <div class="flowerPool">
                <if condition="$info.flower_num gt 0">
                <for start="0" end="$info.flower_num">
                <div class="flowerItem">
                    <img src="__STATIC__/images/icon/花3.png">
                </div>
                </for>
                </if>
                <if condition="$info.flower_num gt 99">
                <span class="flowerPool-count">99+</span>
                </if>
            </div>

            <div class="audience">
                <ul>
                    <if condition="is_array($viewers) && !empty($viewers)">
                    <foreach name="$viewers" item="viewer">
                    <li>
                        <img src="{$viewer.head_pic}" alt="">
                    </li>
                    </foreach>
                    </if>
                </ul>
            </div>
            <div class="details-comments">
                <div class="details-comments-head" style="display: none;">
                    <img src="__STATIC__/images/icon/消息.png">评论&nbsp;（为保护隐私，评论头像和昵称都是随机生成）
                </div>
                <ul>
                    <li class="details-comments-item" v-cloak v-for="(item,index) in commentsList" :key="index">
                        <div style="position: relative;">
                            <div class="comment-headWrap" @click="applyHomepage">
                                <img :src="GlobalHost+item.head_pic" @error="defaultImg">
                            </div>
                        </div>
                        
                        <div class="details-comments-content">
                            <div class="details-item-head">
                                <span class="nickname">{{item.nickname}}</span>
                                <span class="detailsTime">{{item.add_time | stampToStr}}</span>
                            </div>
                            <div class="details-comments-text" @click="startComment(1,item)">{{item.content}}</div>

                            <div class="details-comments-content-second" v-cloak v-if="item.sub&&item.sub.length!==0">
                                <ul class="comments-second-ul">
                                    <li v-cloak v-for="(subItem,subIndex) in item.sub" :key="subIndex">
                                        <div class="details-item-head">
                                            <span class="nickname">{{subItem.nickname}}</span>
                                            <span class="detailsTime">{{subItem.add_time | stampToStr}}</span>
                                        </div>
                                        <div class="details-comments-text">
                                            <span class="replyWrap">回复
                                                <span class="replyPerson">{{subItem.reply_nickname}}</span>：</span>
                                            <span class="details-second-text" @click="startComment(1,subItem)">{{subItem.content}}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="details-tip">
                <img src="__STATIC__/images/icon/tx.png">评论所有人可见，悄悄话仅对方和你可见
            </div>
        </div>

        <div class="details-input">
            <a href="javascript:void(0)" :class={actived:isWhisper} @click="isWhisper=!isWhisper">悄悄话</a>
            <input class="details-realInput" type="text" v-model="inputComment" :placeholder="placeHolder">
            <span class="details-face" style="display: none;"></span>
            <span class="sendComment" @click="sendComment">发送</span>
        </div>

        <div class="flowerDialog" style="display: none;">
            <p>
                您已成功送给对方
                <span class="sendSuccessCount">1</span>朵小花，剩余小花
                <span class="dialogLeftFlowers">99</span>朵
            </p>
            <span class="littleFlower"></span>
        </div>
        <div class="avatarOperating" style="display: none;">
            <ul>
                <li class="">申请查看TA的主页</li>
                <li class="home-cancel">取消</li>
            </ul>
        </div>
        <div class="avatarOperating-jubao" style="display: none;">
            <ul>
                <li class="">举报</li>
                <li class="jubao-cancel">取消</li>
            </ul>
        </div>
        <div class="confirmDelete" style="display: none;">
            <p>
                确认删除评论？
            </p>
            <div class="confirmDelete-btngroup">
                <a href="javascript:void(0)" class="cancelDelete">点错了</a>
                <a href="javascript:void(0)" class="delete">确认删除</a>
            </div>
        </div>

    </div>

<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="__STATIC__/js/vue.js"></script>
<script>
    var GlobalHost = "http://meiliyue.caapa.org";
    var Details = {
        user_id:"",
        dynamic_id:"",
        dynamic_origin_id:"",

        _flowerTimer: null,
        replyDiv: null,
        commentType: 1, 

        giveFlower: function () {
            var postData = {
                user_id: "123",
                dynamics_id: "12"
            }

            $.ajax({
                type: "POST",
                url: GlobalHost+"/index.php/Api/Dynamics/giveFlower",
                data: postData,
                dataType: "json",
                success: function (result) {
                    let sendedFlowersCount = 2 
                    let leftFlowersCount = 99 
                    if (result.msg == "操作成功") {
                        $(".flowerDialog .sendSuccessCount").text(sendedFlowersCount)
                        $(".flowerDialog .dialogLeftFlowers").text(leftFlowersCount)
                        $(".flowerDialog").show().addClass('mfadeout')
                        clearTimeout(Details._flowerTimer)
                        Details._flowerTimer = setTimeout(function () {
                            $('.flowerDialog').hide().removeClass('mfadeout')
                        }, 1300)
                        $(".flowerPool").prepend($(
                            '<div class="flowerItem"><img src="__STATIC__/images/icon/花3.png"></div>'
                        ))
                        $(".flowerPool-count").html(Number($(".flowerPool-count").html()) + 1)
                        if ($(".haveFlower").css("display") == "none") {
                            $(".haveFlower").show()
                            $(".noFlower").hide()
                        }
                        $(".flowerCount").html(Number($(".flowerCount").html()) + 1)
                    }
                }
            })
        },

        applyHomepage: function () {
            if($(".mask").length==0){
                $('body').append($('<div class="mask"></div>'))
            }
            $('.avatarOperating').show()
            $('body').css('overflow', 'hidden')
        },
        initVue: function () {
            var commentsVm = new Vue({
                el: "#vueApp",
                data: {
                    GlobalHost:GlobalHost,
                    commentsList: [],
                    isWhisper: false,
                    placeHolder: "输入评论",
                    inputComment: "",
                    replyItem: null,
                },
                mounted: function () {
                    this.getCommentsList()
                },
                filters: {
                    stampToStr: function (stamp) {
                        if (!stamp) return '';

                        let nowStamp=Math.round((new Date().getTime())/1000);
                        let howLong=nowStamp-stamp;

                        if(howLong<60){
                            return "1分钟内";
                        }else if(howLong<3600){
                            let minutes=Math.floor(howLong/60);
                            return minutes+"分钟前";
                        }else if(howLong<43200){
                            let hours=Math.floor(howLong/3600);
                            return hours+"小时前";
                        }else if(howLong>=43200&&howLong<86400){
                            let dateStr=stampToDate(stamp);
                            console.log(dateStr)
                            let minStr=dateStr.substr(dateStr.length-5);
                            return "昨天 "+minStr;
                        }else if(howLong>86400){
                            return stampToDate(stamp);
                        }
                    }
                },
                methods: {
                    getCommentsList: function () {
                        var self = this
                        var postData = {
                            dynamic_id: Details.dynamic_id
                        }
                        $.ajax({
                            type: "POST",
                            url: GlobalHost+"/index.php/Api/Dynamics/getComment",
                            data: postData,
                            dataType: "json",
                            success: function (result) {
                                console.log(result.data)
                                self.commentsList = result.data
                            }
                        })
                    },
                    startComment: function (type, item) {
                        var el = event.target;
                        if (item&&item.commentator_id&&Number(item.commentator_id)==Number(Details.user_id)) {
                            this.toggleDelete(el);
                        }else{
                            if(type==0){
                                this.placeHolder = "输入评论"
                                this.replyItem = null
                                console.log(1)
                                $(".details-realInput").focus()

                                Details.commentType = 1
                            }else if(type==1){
                                this.placeHolder = "回复" + item.nickname
                                this.replyItem = item
                                console.log(2)
                                $(".details-realInput").focus()

                                Details.commentType = 2
                            }

                            Details.replyDiv = el;
                        }
                        console.log(this.replyItem)
                    },
                    sendComment: function () {
                        console.log(this.replyItem)

                        var self = this;
                        var itemIndex;

                        if (this.inputComment.trim() == "") {
                            return;
                        }

                        var postData = {
                            dynamic_id: Details.dynamic_id,
                            commentator_id: Details.user_id,
                            content: this.inputComment.trim(),
                            private: this.isWhisper?1:null, 

                        };

                        if (this.replyItem) {
                            
                            if (self.replyItem.parent_id == 0) {
                                itemIndex = self.commentsList.indexOf(self.replyItem)
                            } else {
                                self.commentsList.forEach(function (item, index) {
                                    if (item.sub) {
                                        if (item.sub.indexOf(self.replyItem) > -1) {
                                            itemIndex = index
                                            return
                                        }
                                    }
                                })
                            }
                            
                            postData.parent_id=this.commentsList[itemIndex].comment_id;
                            postData.reply_user_id=this.replyItem.commentator_id;
                        } else {
                            postData.parent_id="0";
                            postData.reply_user_id=Details.dynamic_origin_id;
                        }
                        
                        console.log(postData)

                        $.ajax({
                            type: "POST",
                            url: GlobalHost+"/index.php/Api/dynamics/addComment",
                            data: postData,
                            dataType: "json",
                            success: function (result) {
                                console.log(result)
                             
                                if (result.msg == "操作成功") {
                                    self.getCommentsList();

                                    self.inputComment = "";
                                    self.placeHolder = "输入评论";
                                    self.replyItem = null;
                                    self.isWhisper=false;
                                }
                            }
                        })
                    },
                    defaultImg: function (event) {
                        event.target.src = "__STATIC__/images/icon/tx.png"
                    },
                    applyHomepage: function () {
                        if($(".mask").length==0){
                            $('body').append($('<div class="mask"></div>'))
                        }
                        $('.avatarOperating').show()
                        $('body').css('overflow', 'hidden')
                    },
                    toggleDelete:function(el){
                        if($(".mask").length==0){
                            $('body').append($('<div class="mask"></div>'))
                        }
                        $('.confirmDelete').show();
                        $(".cancelDelete").click(function(){
                            $(".mask").remove();
                            $('.confirmDelete').hide();
                        });
                        $(".delete").click(function(){
                            console.log("删除自己的评论")
                        });
                    }
                }
            })
        },
        eventsBind: function () {
            $(".giveFlower").click(function () {
                console.log("送花")
                Details.giveFlower()
            })
            $(".details-headImgWrap").click(function () {

            })
            $(".home-cancel").click(function () {
                $('.mask').remove()
                $('.avatarOperating').hide()
                $('body').css('overflow', 'auto')
            })
            $(".operate").click(function () {
                if($(".mask").length==0){
                    $('body').append($('<div class="mask"></div>'))
                }
                $('.avatarOperating-jubao').show()
                $('body').css('overflow', 'hidden')
            })
            $(".jubao-cancel").click(function () {
                $('.mask').remove()
                $('.avatarOperating-jubao').hide()
                $('body').css('overflow', 'auto')
            });
        },
        init: function () {
            Details.user_id=1;
            Details.dynamic_id=1;
            Details.dynamic_origin_id=1;

            Details.initVue()

            Details.eventsBind()
        }
    }
    $(function () {
        Details.init()
    });
    function stampToDate(timestamp) {
        var date = new Date(timestamp * 1000);
        Y = date.getFullYear() + '-';
        M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
        D = (date.getDate()<10?"0"+date.getDate():date.getDate()) + ' ';
        h = (date.getHours()<10?"0"+date.getHours():date.getHours()) + ':';
        m = (date.getMinutes()<10?"0"+date.getMinutes():date.getMinutes());
        return Y+M+D+h+m;
    }
</script>
</body>

</html>