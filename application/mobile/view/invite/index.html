<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>邀约</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/weui.css">
    <link rel="stylesheet" href="__STATIC__/js/js-plugins/jquery-weui-build/jquery-weui.min.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/common.css">
    <script>
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
</head>

<body class="yaoyueIndex">
    <header>
        <span class="title">邀约</span>
    </header>

    <div class="main-content invitation indexPage" id="indexPageApp">

        <div class="blurDiv" :class="{blur:isPlusing}">

            <div class="inviteTopWrap">
                <div class="view">
                    <a href="javascript:void(0)">
                        <img src="__STATIC__/images/pic/pic2.png">
                    </a>
                </div>
                <div class="classify">
                    <div class="optionsWrap">
                        <div class="options clearfix">
                            <ul class="fl">
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn allBtn" @click="handleOption('allBtn')">
                                        <span :class="{actived:nowOptionBtn=='allBtn'}">全部</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn travelBtn" @click="handleOption('travelBtn')">
                                        <span :class="{actived:nowOptionBtn=='travelBtn'}">旅行</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn foodBtn" @click="handleOption('foodBtn')">
                                        <span :class="{actived:nowOptionBtn=='foodBtn'}">吃饭</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn movieBtn" @click="handleOption('movieBtn')">
                                        <span :class="{actived:nowOptionBtn=='movieBtn'}">电影</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn singBtn" @click="handleOption('singBtn')">
                                        <span :class="{actived:nowOptionBtn=='singBtn'}">唱歌</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn sportBtn" @click="handleOption('sportBtn')">
                                        <span :class="{actived:nowOptionBtn=='sportBtn'}">运动</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0)" class="optionsBtn otherBtn" @click="handleOption('otherBtn')">
                                        <span :class="{actived:nowOptionBtn=='otherBtn'}">其他</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="addressWrap">
                        <div class="address clearfix" @click="opentSelect">
                            <span class="fl" @click.stop="cancelSelectList">{{selectedText}}
                                <span class="cancelSelected" v-cloak v-if="selectedText!=='辽宁'"></span>
                            </span>
                            <span class="select fr">筛选</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dropRefresh">
                <div class="weui-pull-to-refresh__layer">
                    <div class='weui-pull-to-refresh__arrow'></div>
                    <div class='weui-pull-to-refresh__preloader'></div>
                    <div class="down">下拉刷新</div>
                    <div class="up">释放刷新</div>
                    <div class="refresh">正在刷新</div>
                </div>


                <div class="items mInviteList">
                    <ul>
                        <li class="mInviteList-item" v-cloak v-for="(item,index) in inviteList" :key="index">
                            <span class="active ding" style="display: none;">
                                <span class="dingText">顶</span>
                            </span>
                            <div class="top">
                                <div style="position: relative;">
                                    <div class="img-box" @click="gotoInviteDetail(item)">
                                        <img :src="GlobalHost+item.head_pic" @error="defaultImg">
                                    </div>
                                    <span class="videoStatus" v-cloak v-show="item.auth_video_status==1" @click="showVideo(item)"></span>
                                </div>
                                
                                <div class="details">
                                    <div class="person">
                                        <span class="name">{{item.nickname}}</span>
                                        <span class="sexAge" :class="{female:item.sex=='2',male:item.sex=='1'}">
                                            <i class="sex"></i>
                                            <span class="age">23</span>
                                        </span>
                                        <span class="img">
                                            <img v-cloak v-if="item.auth_video_status==1" src="__STATIC__/images/icon/camera.png">
                                        </span>
                                        <span class="job" style="display: none;">职业经理人</span>
                                    </div>
                                    <div class="distance">{{item.distince}}km</div>
                                </div>
                            </div>
                            <div class="bottom clearfix">
                                <p class="title">
                                    <span class="bigDot"></span>{{item.title}}</p>
                                <div class="more" @click="openInviteDetail(item)">
                                    <ul>
                                        <li v-cloak v-if="item.description&&item.description!==''">
                                            <span class="smallDot"></span>{{item.description}}</li>
                                        <li v-cloak v-if="item.time&&item.time!==''">
                                            <span class="smallDot"></span>{{item.time}}</li>
                                        <li v-cloak v-if="item.place&&item.place!==''">
                                            <span class="smallDot"></span>{{item.place}}</li>
                                    </ul>
                                    <div v-cloak v-if="item.image&&item.image!==''">
                                        <img :src="GlobalHost+item.image">
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>


                    <div class="noComments" style="display: none;">
                        <img src="__STATIC__/images/icon/暂无要找内容.png">
                        <p>暂时没有你要找的内容</p>
                    </div>
                </div>


                <div class="weui-loadmore">
                    <i class="weui-loading"></i>
                    <span class="weui-loadmore__tips">正在加载</span>
                </div>
            </div>

        </div>

        <div class="plus" :class="{actived:isPlusing}" @click="isPlusing=!isPlusing"></div>

        <div class="m_shade" v-cloak v-if="isPlusing"></div>

        <div class="mask" v-cloak v-show="isPlusing">
            <div class="title">发起邀约</div>
            <div class="box-top">
                <ul>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(1)">
                            <span class="travel"></span>旅行</a>
                    </li>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(2)">
                            <span class="food"></span>吃饭</a>
                    </li>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(3)">
                            <span class="movie"></span>电影</a>
                    </li>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(4)">
                            <span class="sing"></span>唱歌</a>
                    </li>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(5)">
                            <span class="sport"></span>运动</a>
                    </li>
                    <li>
                        <a href="javascript:void(0)" @click="openReleaseInvite(6)">
                            <span class="other"></span>其他</a>
                    </li>
                </ul>
            </div>

            <span class="maskTrgle"></span>
        </div>

        <div class="select-page" :class="{actived:showSelect}">
            <header>
                <a href="javascript:void(0)" class="back fl closeSelect" @click="closeSelect"></a>
                <span class="title">筛选</span>
                <a href="javascript:void(0)" class="fr search" @click="searchBySelect">搜索</a>
            </header>
            <div class="main-content invitation viewOpen selectPage">
                <div class="tabs">
                    <p class="title">排序</p>
                    <ul class="horizontal fr">
                        <li v-cloak v-for="(item,index) in sortList" :class="{active:index==nowSortIndex}" :key="index" @click="cutSort(index)">
                            <a href="javascript:void(0)">{{item}}</a>
                        </li>
                    </ul>

                    <p class="title">约会</p>

                    <div class="tab-content items view-list" id="tab-detail1">
                        <ul class="opened">
                            <li class="gender clearfix">
                                <span class="fl">性别</span>
                                <span class="fr">
                                    <span :class="{active:nowSex=='全部'}" @click="cutSex('全部')">全部</span>
                                    <span :class="{active:nowSex=='男'}" @click="cutSex('男')">男</span>
                                    <span :class="{active:nowSex=='女'}" @click="cutSex('女')">女</span>
                                </span>
                            </li>
                            <li class="diqu clearfix" v-cloak v-show="nowSortIndex!==2">
                                <span class="fl">地区</span>
                                <a href="javascript:void(0)" class="fr">
                                    <input type="text" id='city-picker' />
                                </a>
                            </li>
                            <li class="present clearfix">
                                <div class="weui-cell weui-cell_switch">
                                    <div class="weui-cell__bd">礼物</div>
                                    <div class="weui-cell__ft">
                                        <input class="weui-switch" type="checkbox">
                                    </div>
                                </div>
                            </li>
                            <li class="select clearfix">
                                <div class="weui-cell weui-cell_switch">
                                    <div class="weui-cell__bd">只看视频认证用户</div>
                                    <div class="weui-cell__ft">
                                        <input class="weui-switch onlyVideo" type="checkbox" v-model="onlyVideo">
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="__STATIC__/js/vue.js"></script>
    <script src="__STATIC__/js/js-plugins/jquery-weui-build/jquery-weui.min.js"></script>
    <script src="__STATIC__/js/js-plugins/jquery-weui-build/city-picker.min.js"></script>
    <script>
        $(function () {
            var GlobalHost = "http://meiliyue.caapa.org";

            $(".options li").width($(".optionsWrap").width() / 6)

            let yaoyueIndexVm = new Vue({
                el: "#indexPageApp",
                data: {
                    GlobalHost:GlobalHost,

                    user_id:"",

                    nowOptionBtn: "allBtn",
                    optionsList: ["allBtn", "travelBtn", "foodBtn", "movieBtn", "singBtn", "sportBtn",
                        "otherBtn"
                    ],

                    showSelect: false,
                    inviteList: [],
                    nowPageIndex: 1,
                    isPlusing: false,

                    selectedText: "辽宁", 

                    sortList: ["最近发布", "近期约会", "离我最近"],
                    nowSortIndex: 0,
                    nowSex: "全部", 
                    nowProvince: null, 
                    nowCity: null,
                    onlyGift: false,
                    onlyVideo: false,

                    isLoading: false
                },
                computed: {
                    type() {
                        return this.optionsList.indexOf(this.nowOptionBtn) == 0 ? null : this.optionsList
                            .indexOf(this.nowOptionBtn)
                    }
                },
                mounted() {
                    let _self = this

                    this.user_id=1;

                    document.getElementsByClassName('dropRefresh')[0].addEventListener('scroll', this.handleAddress);
                    
                    this.initPullToRefresh();

                    $("#city-picker").cityPicker({
                        title: "请选择地区",
                        showDistrict: false
                    });

                    if (sessionStorage.getItem("inviIndexPage")) {
                        let inviIndexPageData = JSON.parse(sessionStorage.getItem("inviIndexPage"))
                        console.log(inviIndexPageData)

                        this.nowOptionBtn = inviIndexPageData.nowOptionBtn
                        this.inviteList = inviIndexPageData.inviteList
                        this.nowPageIndex = inviIndexPageData.nowPageIndex
                        this.selectedText = inviIndexPageData.selectedText
                        this.nowProvince = inviIndexPageData.nowProvince
                        this.nowCity = inviIndexPageData.nowCity

                        setTimeout(function () {
                            document.getElementsByClassName('dropRefresh')[0].scrollTop =inviIndexPageData.pageScrollTop
                        }, 0);

                        return;
                    }

                    this.getInviteList()
                },
                methods: {
                    getInviteList({
                        longitude = "41",
                        latitude = "123",
                        type = null,
                        sex = null,
                        province = null,
                        city = null,
                        auth_video = null,
                        page = 1,
                    } = {}, isScroll) {
                        let _self = this
                        let postDataTemp = {
                            longitude: longitude,
                            latitude: latitude,
                            type: type,
                            sex: sex,
                            province: province,
                            city: city,
                            auth_video: auth_video,
                            page: page
                        }
                        console.log(postDataTemp)
                        $.ajax({
                            type: "POST",
                            url: GlobalHost+"/index.php/Api/Invite/index",
                            data: postDataTemp,
                            dataType: "json",
                            success: function (result) {
                                console.log(result.data)
                                if (isScroll) {
                                    _self.inviteList = _self.inviteList.concat(result.data)
                                    
                                    if(result.data.length !== 0){
                                        _self.nowPageIndex = _self.nowPageIndex + 1;
                                    }
                                } else {
                                    _self.inviteList = result.data

                                    if(result.data.length == 0){
                                        $(".noComments").show();
                                    }else{
                                        $(".noComments").hide();
                                    }
                                }


                                $(".dropRefresh").pullToRefreshDone();
                                _self.isLoading = false;

                                if(result.data.length==0){
                                    $(".weui-loadmore").hide();
                                }
                            }
                        })
                    },
                    handleOption(btnStr) {
                        this.nowOptionBtn = btnStr
                        let type = this.optionsList.indexOf(btnStr)
                        this.getInviteList({
                            type: type !== 0 ? type : null
                        })
                    },
                    defaultImg(event) {
                        event.target.src = "__STATIC__/images/icon/tx.png"
                    },
                    openInviteDetail(item) {
                        console.log(item)
                        this.savePageToSession()

                        let options={
                            originUserId:this.user_id,
                            toUserId:item.user_id,
                            detailId:item.id,
                        };

                        let toUrl=GlobalHost + "/index.php/mobile/invite/detail.html?options="+JSON.stringify(options);
                        console.log(toUrl)

                        window.location.href = toUrl;
                    },
                    handleAddress() {
                        let scrollTemp = document.getElementsByClassName('dropRefresh')[0].scrollTop;
                        let wrapHeight=document.getElementsByClassName('dropRefresh')[0].clientHeight;
                        let ulHeight=document.getElementsByClassName('mInviteList')[0].clientHeight;
                        if (scrollTemp >= 100) {
                            $(".inviteTopWrap").css("margin-top","-206px");
                        } else {
                            $(".inviteTopWrap").css("margin-top","0");
                        }
                        console.log(scrollTemp + wrapHeight - ulHeight)
                        if (scrollTemp > 0 && scrollTemp + wrapHeight - ulHeight>=85) {
                            if(!this.isLoading){
                                this.isLoading = true;
                                console.log("滑动加载")
                                let sex
                                switch (this.nowSex) {
                                    case "全部":
                                        sex = null
                                        break;
                                    case "男":
                                        sex = "1"
                                        break;
                                    case "女":
                                        sex = "2"
                                        break;
                                    default:
                                        break;
                                }
                                this.isLoading = true;
                                this.getInviteList({
                                    type: this.type,
                                    sex: sex,
                                    province: this.nowProvince,
                                    city: this.nowCity,
                                    auth_video: this.onlyVideo ? "1" : "0",
                                    page: this.nowPageIndex + 1
                                }, true)
                            }
                        }
                    },
                    opentSelect() {
                        this.showSelect = true
                    },
                    resetSelectPage() {
                        this.nowSortIndex = 0
                        this.nowSex = "全部"
                        this.onlyGift = false
                        this.onlyVideo = false
                        $("#city-picker").val("")
                    },
                    cancelSelectList() {
                        if (this.selectedText !== "辽宁") {
                            let type = this.type
                            this.getInviteList({
                                type: type
                            })

                            $(".indexPage").animate({
                                scrollTop: 0
                            }, 300)

                            this.selectedText = "辽宁"
                            this.nowProvince = null
                            this.nowCity = null

                            this.resetSelectPage()
                        }
                    },
                    openReleaseInvite(type) { 
                        this.savePageToSession()

                        $(".plus")[0].click();

                        window.location.href = GlobalHost + "/index.php/mobile/invite/add/type/" + type + ".html"
                    },
                    savePageToSession() {
                        let pageData = {
                            nowOptionBtn: this.nowOptionBtn,
                            inviteList: this.inviteList,
                            nowPageIndex: this.nowPageIndex,
                            selectedText: this.selectedText,
                            nowProvince: this.nowProvince,
                            nowCity: this.nowCity,

                            pageScrollTop: document.getElementsByClassName('dropRefresh')[0].scrollTop
                        }
                        sessionStorage.setItem('inviIndexPage', JSON.stringify(pageData))
                    },
                    initPullToRefresh(){
                        let _self = this;
                        $(".dropRefresh").pullToRefresh(function () {
                            console.log("刷新")
                            let sex
                            switch (_self.nowSex) {
                                case "全部":
                                    sex = null
                                    break;
                                case "男":
                                    sex = "1"
                                    break;
                                case "女":
                                    sex = "2"
                                    break;
                                default:
                                    break;
                            }
                            _self.getInviteList({
                                type: _self.type,
                                sex: sex,
                                province: _self.nowProvince,
                                city: _self.nowCity,
                                auth_video: _self.onlyVideo ? "1" : "0"
                            })
                        })
                    },
                    gotoInviteDetail(item){
                        this.savePageToSession();

                        window.location.href = GlobalHost+"/index.php/mobile/user/homePage/user_id/"+this.user_id+"/toUserId/"+item.user_id+".html";
                    },
                    openVideoScreen(item){
                        let self=this;
                        let toUserId=item.user_id;
                        let head_pic=GlobalHost+item.head_pic;
                        console.log(head_pic)
                        this.getVideoUrl(toUserId,function(url){
                            self.showVideo({
                                user_id:toUserId,
                                head_pic:head_pic,
                                src:url
                            });
                        });
                    },
                    getVideoUrl(user_id,callback){
                        $.ajax({
                            type: "POST",
                            url: GlobalHost+"/index.php/Api/user/getAuthVideoUrl",
                            data: {
                                user_id:user_id
                            },
                            dataType: "json",
                            success: function (result) {
                                console.log(result)
                                if(result.code==200){
                                    let url=GlobalHost+result.data.video_url;
                                    callback(url);
                                }
                            }
                        });
                    },
                    showVideo:function({user_id,head_pic,src}){
                        console.log(user_id,head_pic,src)
                        let $fullScreen=$(`
                            <div class="fullScreen">
                                <div class="videoHeader">
                                    <div class="closeFullScreen"></div>
                                    <div class="videoOperate"></div>
                                    <div class="img-box">
                                        <img src=${head_pic}>
                                    </div>
                                </div>

                                <div class="fullScreenScroll">
                                    <div class="fullScreenWrap">
                                        <span class="progressBar"></span>
                                        <video id="video1" width="100%" height="100%" src=${src} autoplay loop></video>
                                        <div class="videoFooter">
                                            <div class="videoCommentBtn"></div>
                                            <span class="littleTri"></span>
                                        </div>
                                    </div>
                                    <!-- 小视频评论 -->
                                    <div class="" style="height: 300px;background-color: red;;">

                                    </div>
                                    
                                    <!-- 小视频评论input -->
                                    <div class="videoInput">
                                        <input type="text">
                                        <span class="sendComment">发送</span>
                                    </div>
                                </div>
                            </div>
                        `);

                        $fullScreen.find(".closeFullScreen").click(function(){
                            $fullScreen.remove();
                        });
                        
                        $("body").append($fullScreen);
                    },

                    cutSort(index) {
                        this.nowSortIndex = index
                    },
                    cutSex(sexStr) {
                        this.nowSex = sexStr
                    },
                    closeSelect() {
                        this.showSelect = false
                    },
                    searchBySelect() {
                        this.closeSelect()
                        let type = this.type
                        let sex
                        switch (this.nowSex) {
                            case "全部":
                                sex = null
                                break;
                            case "男":
                                sex = "1"
                                break;
                            case "女":
                                sex = "2"
                                break;
                            default:
                                break;
                        }
                        let cityCodes = $("#city-picker").attr("data-codes")
                        let provinceCode, cityCode
                        if (cityCodes) {
                            provinceCode = cityCodes.split(",")[0]
                            cityCode = cityCodes.split(",")[1]
                            this.nowProvince = provinceCode
                            this.nowCity = cityCode
                        }
                        let onlyGift = this.onlyGift
                        let onlyVideo = this.onlyVideo

                        $(".indexPage").animate({
                            scrollTop: 0
                        }, 300)

                        let cityTemp = $("#city-picker").val()
                        console.log(cityTemp)
                        let textTemp = cityTemp + (this.nowSex == "全部" ? "" : " " + this.nowSex) + (
                            onlyVideo ? " 已认证" : "") + (onlyGift ? " 参加礼物" : "")

                        console.log(textTemp)

                        this.selectedText = textTemp.trim() == "" ? "辽宁" : textTemp

                        this.getInviteList({
                            type: type,
                            sex: sex,
                            province: provinceCode,
                            city: cityCode,
                            auth_video: onlyVideo ? "1" : "0"
                        })

                    }
                }
            })
        })
    </script>

</body>

</html>