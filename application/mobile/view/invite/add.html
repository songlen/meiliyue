<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>发布邀约</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css-dist/invite-add.min.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/common.css">
    <script>
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
</head>

<body class="releInvite-page">
    <header>
        <span class="fl cancle">取消</span>
        <span class="fr publish">发布</span>
    </header>
    <div class="main-content invitation">
        <form id="releInviteForm" action="http://meiliyue.caapa.org/index.php/Api/invite/add" method="post" enctype="multipart/form-data">
            <!-- 隐藏域 -->
            <input type="text" value="" name="user_id" style="display: none;">
            <input type="text" value="" name="user_sex" style="display: none;">
            <input type="text" value="" name="type" style="display: none;">
            <input type="text" value="" name="title" style="display: none;">
            <input type="text" value="" name="description" style="display: none;">
            <input type="text" value="" name="time" style="display: none;">
            <input type="text" value="" name="province" style="display: none;">
            <input type="text" value="" name="city" style="display: none;">
            <input type="text" value="" name="place" style="display: none;">
            <input type="text" value="" name="object" style="display: none;">
            <input type="text" value="" name="pay" style="display: none;">
            <input type="text" value="" name="is_jiesong" style="display: none;">
            <input type="text" value="" name="with_confidante" style="display: none;">
            <input type="text" value="" name="longitude" style="display: none;">
            <input type="text" value="" name="latitude" style="display: none;">
            <!-- 隐藏域 end -->
            <div class="theme items">
                <ul>
                    <li class="clearfix title">
                        <span class="fl">主题</span>
                        <span class="fr inviteTheme"></span>
                    </li>
                    <li class="clearfix">
                        <span class="fl">地点</span>
                        <span class="fr">
                            <!-- <input type="text" id='city-picker' value="辽宁省 沈阳市" /> -->
                            <input type="text" id='city-picker' />
                        </span>
                    </li>
                    <li class="detailPlace">
                        <div class="detailPlace-title">
                            详细地点
                        </div>
                        <div class="detailPlace-inputWrap">
                            <input type="text" placeholder="填写详细地点..." />
                        </div>
                    </li>
                    <li class="clearfix">
                        <span class="fl">时间</span>
                        <span class="fr">
                            <input type="text" id='datetime-picker' />
                            <!-- <input id='datetime-picker' type="text" data-toggle='date' /> -->
                        </span>
                    </li>
                </ul>
                <ul>
                    <li class="detailSelect clearfix otherSide">
                        <span class="fl">对象</span>
                        <span class="fr choose">
                            <span class="active">男</span>
                            <span>女</span>
                            <span>不限</span>
                        </span>
                    </li>
                    <li class="detailSelect clearfix payMoney">
                        <span class="fl">买单</span>
                        <span class="fr choose">
                            <span>AA</span>
                            <span class="active">当然你买</span>
                        </span>
                    </li>
                    <li class="clearfix catch">
                        <span class="fl">
                            <input type="checkbox" checked="checked" id="myCheck">
                            <label for="myCheck"></label>
                            <label for="myCheck">需要接送我</label>
                        </span>
                        <span class="fr">
                            <input type="checkbox" checked="checked" id="myCheck1">
                            <label for="myCheck1"></label>
                            <label for="myCheck1">对方可携带三两好友</label>
                        </span>
                    </li>
                </ul>
                <ul>
                    <li class="clearfix" id="descriptionWrap-li">
                        <div class="descriptionWrap">
                            <textarea id="descripTextarea" placeholder="空泛的说明，是没有人报名的..."></textarea>

                            <span class="textCountWrap">
                                <span class="textCount">0</span>/200</span>
                        </div>

                        <div>
                            <!-- 添加图片 -->
                            <div class="add">
                                <ul class="showPicUl">
                                    <a href="javascript:void(0)" class="addPic">
                                        <img src="__STATIC__/images/icon/add.png">
                                    </a>
                                </ul>
                            </div>
                            <!-- 添加录音 -->
                            <!-- <div class="speak" style="display: none;">
                                <a href="javascript:;">
                                    按住说话
                                </a>
                            </div> -->
                        </div>

                    </li>
                </ul>
            </div>
        </form>
    </div>

    <!-- 模态框 -->
    <div class="confirmDelete" style="display: none;">
        <p>
            你尚未发布，确认删除？
        </p>
        <div class="confirmDelete-btngroup">
            <a href="javascript:void(0)" class="cancelDelete">取消</a>
            <a href="javascript:void(0)" class="delete">确定</a>
        </div>
    </div>

    <script src="__STATIC__/js-dist/invite-add.min.js"></script>
    <script type="text/javascript">
        var GlobalHost = "http://meiliyue.caapa.org";
        var ReleInvite = {
            inviteList: [{
                title: "旅行",
                type: 1
            }, {
                title: "吃饭",
                type: 2
            }, {
                title: "电影",
                type: 3
            }, {
                title: "唱歌",
                type: 4
            }, {
                title: "运动",
                type: 5
            }, {
                title: "其他",
                type: 6
            }],

            _type: "",
            _user_id: "",
            _user_sex: "",

            _theme: "",



            //获取页面基本参数
            getPageData: function () {
                //user_id sex
                if (localStorage.getItem("mUserInfo") && localStorage.getItem("mUserInfo") !== null &&
                    localStorage.getItem("mUserInfo") !== "null") {
                    let mUserInfo = JSON.parse(JSON.parse(localStorage.getItem("mUserInfo")));
                    console.log(mUserInfo)
                    ReleInvite._user_id = Number(mUserInfo.user_id);
                    ReleInvite._user_sex = Number(mUserInfo.sex);
                } else {
                    ReleInvite._user_id = 1; //测试用
                    ReleInvite._user_sex = 2; //测试用
                }
                console.log(ReleInvite._user_id)

                //type
                var ulrStr = window.location.href;
                if (ulrStr.indexOf("file://") > -1) {
                    ulrStr = "http://meiliyue.caapa.org/index.php/mobile/invite/add/type/3.html" //测试用
                }
                var strTemp = ulrStr.split("/add/type/")[1];
                ReleInvite._type = Number(strTemp.substr(0, strTemp.length - 5));

                //更新dom
                ReleInvite.updateDom();
            },
            updateDom: function () {
                //主题
                ReleInvite.inviteList.forEach(function (obj) {
                    if (obj.type == ReleInvite._type) {
                        ReleInvite._theme = obj.title
                    }
                });
                if (ReleInvite._theme == "其他") {
                    $(".inviteTheme").html(
                        `
                            <input id="mTitle" type="text" placeholder="输入主题"/>
                        `
                    );
                } else {
                    $(".inviteTheme").html(ReleInvite._theme);
                }

                //根据sex 修改"当然你买"

                //
            },
            initSomeDom: function () {
                //地点，时间 选择器
                $("#city-picker").cityPicker({
                    title: "请选择地区",
                    showDistrict: false
                });
                $("#datetime-picker").calendar({
                    dateFormat: "yyyy-mm-dd"
                });
                //复选框
                document.getElementById("myCheck").checked = false;
                document.getElementById("myCheck1").checked = false;
            },
            //改变 地址 选择器默认值
            setAreaDefault: function () {

            },
            //限制字数
            bindLimitCount: function () {
                let textarea = document.getElementById('descripTextarea')
                textarea.onchange = function () {
                    limitCount(this)
                }
                textarea.onkeydown = function () {
                    limitCount(this)
                }
                textarea.onkeyup = function () {
                    limitCount(this)
                }

                function limitCount(el) {
                    let vInnerHtml = el.value
                    el.value = el.value.substring(0, 200) //限制字数
                    let count = vInnerHtml.length
                    document.getElementsByClassName('textCount')[0].innerHTML = count
                    if (count >= 200) {
                        ReleInvite.messageWin("最多输入200个字");
                    }
                }
            },
            messageWin: function (msg) {
                if ($(".msgWrap").length == 0) {
                    let $msgDiv = $(
                        `
                        <div class="msgWrap">
                            <div class="msg">
                                <p class="msgText">${msg}</p>
                                <p class="msgCtrl">
                                    <span class="closeMsg">确定</span>
                                </p>
                            </div>
                        </div>
                    `
                    );
                    //msg点击事件
                    $msgDiv.find(".msgCtrl").click(function () {
                        $msgDiv.remove();
                    });
                    $("body").append($msgDiv);
                }
            },
            addPic: function () {
                if ($(".edit-pic-item").length >= 3) {
                    ReleInvite.messageWin("最多上传3张图片");
                    return;
                }
                var $liTemp = $(
                    `
                    <li class="edit-pic-item">
                        <input class="albumInput" name="file[]" type="file" accept="image/*" value="" style="display: none">
                        <img class="showPic" data-index=${$(".edit-pic-item").length} src="__STATIC__/images/icon/tx.png">
                        <a href="javascript:void(0)" class="edit-closePic"></a>
                    </li>
                    `
                );

                $liTemp.find(".albumInput").bind("change", function () {
                    readURL(this);
                });
                readURL(this);

                //触发点击input file
                $liTemp.find(".albumInput")[0].click();

                function readURL(input) {
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            $liTemp.find('.showPic').attr('src', e.target.result);

                            //添加图片成功 后
                            $(".showPicUl").prepend($liTemp);

                            //取消图片
                            $liTemp.find("a.edit-closePic").click(function () {
                                ReleInvite.cancelPic(this)
                            })
                        }
                        reader.readAsDataURL(input.files[0]);
                    }
                }
            },
            //发布邀约
            publishInvit: function () {
                //主题
                let title = $("#mTitle").length !== 0 ? $("#mTitle").val().trim() : $(".inviteTheme").text();
                if (title === "") {
                    ReleInvite.messageWin("请填写主题");
                    return;
                }
                //省市code
                let cityCodes = $("#city-picker").attr("data-codes")
                let provinceCode, cityCode
                if (cityCodes) {
                    provinceCode = cityCodes.split(",")[0]
                    cityCode = cityCodes.split(",")[1]
                }

                if (!cityCodes || $("#datetime-picker").val() == "") {
                    // alter("地点和时间请填写完整");
                    ReleInvite.messageWin("地点和时间请填写完整");
                    return;
                }

                //file
                // let fileArr = [];
                // if ($(".albumInput").length !== 0) {
                //     $(".albumInput").each(function () {
                //         fileArr.push(this.files[0]);
                //         // fileArr.push(new FormData(this));
                //     });
                // }

                // let posiArr=ReleInvite.getLocalPosition();
                // console.log(fileArr)
                // var postData = {
                //     user_id: ReleInvite._user_id,
                //     user_sex: ReleInvite._user_sex,
                //     type: ReleInvite._type,
                //     title: ReleInvite._theme,

                //     description: $("#descripTextarea").val().trim(),
                //     time: $("#datetime-picker").val(),
                //     province: provinceCode,
                //     city: cityCode,
                //     place: $(".detailPlace-inputWrap>input").val().trim(),
                //     object: $(".otherSide .choose .active").text(),
                //     pay: $(".payMoney .choose .active").text(),
                //     is_jiesong: $("#myCheck").is(':checked') ? 1 : 0,
                //     with_confidante: $("#myCheck1").is(':checked') ? 1 : 0,

                //     file: fileArr, //支持多张图片 //测试用
                //     // file:[],

                //     // longitude: posiArr[0], 
                //     // latitude: posiArr[1], 
                //     longitude: "",
                //     latitude: "",
                // }

                // console.log(postData)

                // $.ajax({
                //     type: "POST",
                //     url: GlobalHost + "/index.php/Api/invite/add",
                //     data: postData,
                //     dataType: "json",
                //     cache: false,
                //     processData: false,
                //     contentType: false,
                //     success: function (result) {
                //         console.log(result)
                //         if (result.msg == "操作成功") {

                //             ReleInvite.closeLoading("发布成功", function () {
                //                 //关闭 返回
                //                 //window.history.back(-1)
                //             });
                //         }
                //     }
                // });


                //jquery.form.js方法
                $(":input[name='user_id']").val(ReleInvite._user_id);
                $(":input[name='user_sex']").val(ReleInvite._user_sex);
                $(":input[name='type']").val(ReleInvite._type);
                if (ReleInvite._theme == "其他") {
                    $(":input[name='title']").val($(".inviteTheme #mTitle").val().trim());
                } else {
                    $(":input[name='title']").val(ReleInvite._theme);
                }
                $(":input[name='description']").val($("#descripTextarea").val().trim());
                $(":input[name='time']").val($("#datetime-picker").val());
                $(":input[name='province']").val(provinceCode);
                $(":input[name='city']").val(cityCode);
                $(":input[name='place']").val($(".detailPlace-inputWrap>input").val().trim());
                $(":input[name='object']").val($(".otherSide .choose .active").text());
                $(":input[name='pay']").val($(".payMoney .choose .active").text());
                $(":input[name='is_jiesong']").val($("#myCheck").is(':checked') ? 1 : 0);
                $(":input[name='with_confidante']").val($("#myCheck1").is(':checked') ? 1 : 0);
                $(":input[name='longitude']").val("");
                $(":input[name='latitude']").val("");


                ReleInvite.openLoading();

                $("#releInviteForm").ajaxSubmit(function (result) {  
                    console.log(result)                  
                    if (result.msg == "操作成功") {
                        ReleInvite.closeLoading("发布成功", function () {
                            //关闭 返回
                            window.history.back(-1);
                        });
                    }  
                });

            },
            openLoading: function () {
                if ($(".msgWrap").length == 0) {
                    $("body").append($('<div class="msgWrap"></div>'));
                }
                if ($(".mLoading").length == 0) {
                    $("body").append($('<div class="mLoading">处理中...</div>'));
                }
            },
            closeLoading: function (resultMsg, callback) {
                $(".mLoading").html(resultMsg);
                setTimeout(function () {
                    $(".mLoadingMask")
                        .add($(".mLoading")).remove();
                    callback();
                }, 500);
            },
            cancelPic: function (el) { //pic的a标签
                if ($(".msgWrap").length == 0) {
                    $('body').append($('<div class="msgWrap"></div>'));
                }
                $('.confirmDelete').show()

                //取消删除
                $(".cancelDelete").click(function () {
                    $('.msgWrap').remove()
                    $('.confirmDelete').hide()
                })
                //确认删除
                $(".delete").click(function () {
                    $('.msgWrap').remove()
                    $('.confirmDelete').hide()

                    $(el).closest('.edit-pic-item').remove()
                })
            },
            showFullPic: function (el) {
                let index = $(el).attr("data-index");
                let srcArr = [];
                $(".showPicUl .showPic").each(function () {
                    srcArr.unshift($(this).attr("src"));
                });
                console.log(srcArr)
                let swiper = $.photoBrowser({
                    items: srcArr
                });
                // swiper.open(index);
                swiper.open();
            },
            eventsBind: function () {
                //取消发布
                $(".cancle").click(function () {
                    window.history.back(-1)
                })
                //切换男女,切换买单
                $(".detailSelect .choose>span").click(function () {
                    $(this).addClass('active').siblings().removeClass('active')
                })
                //让textarea限制字数
                ReleInvite.bindLimitCount()
                //发布邀约
                $(".publish").click(function () {
                    ReleInvite.publishInvit()
                });
                //添加图片
                $(".addPic").click(function () {
                    ReleInvite.addPic();
                });
                //点击图片显示大图
                $(".showPicUl").delegate(".showPic", "click", function () {
                    console.log($(this).attr("src"))
                    ReleInvite.showFullPic(this);
                });
            },
            init: function () {
                //获取页面基本信息
                ReleInvite.getPageData()

                //初始化 地点 时间 选择器
                ReleInvite.initSomeDom();

                //
                ReleInvite.eventsBind()
            }
        };

        $(function () {
            ReleInvite.init();
        });
    </script>
</body>

</html>