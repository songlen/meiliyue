<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>我感兴趣</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css-dist/invite-detail.min.css">
    <link rel="stylesheet" href="__STATIC__/css/common.css">
    <script>
        document.documentElement.style.fontSize = document.documentElement.clientWidth / 375 * 100 + 'px';
    </script>
</head>

<body class="interested">
    <header>
        <a href="javascript:void(0)" class="back fl"></a>
        <span class="title">邀约详情</span>
        <a href="javascript:void(0)" class="operate fr"></a>
    </header>

    <div class="invitation-enrollWrap">

        <div class="main-content invitation">
            <div class="items invite-detail">
                <ul>
                    <li>
                        <div class="top">
                            <div class="img-box">
                                <img src="__STATIC__/images/icon/tx.png">
                            </div>
                            <div class="details">
                                <div class="person">
                                    <span class="name"></span>
                                    <span class="sexAge">
                                        <i class="sex"></i>
                                        <span class="age"></span>
                                    </span>
                                    <!-- <span class="distance fr">
                                        <span class="distanceText">100</span>km
                                    </span> -->
                                </div>
                                <div class="" style="margin-top: 10px;"></div>
                            </div>
                        </div>

                    </li>
                    <!-- 邀约详情 -->
                    <li class="detail inviteDetail">
                        <ul class="inviteDetail-list">
                            <li>
                                <span class="bigDot"></span>
                                <span class="title"></span>
                            </li>
                            <li class="descriptionLi">
                                <span class="smallDot"></span>
                                <span class="description"></span>
                            </li>
                            <!-- <li class="detailImages">
                                <img class="inviImg" data-index=${index} src=${Global.host+src}>
                            </li> -->
                            <li>
                                <span class="smallDot"></span>
                                <span class="payType"></span>
                            </li>
                            <li>
                                <span class="smallDot"></span>
                                <span class="otherSideSex"></span>
                            </li>
                        </ul>
                    </li>
                </ul>

                <ul class="areaTime">
                    <li>
                        时间：
                        <span class="detailTime"></span>
                    </li>
                    <li>
                        地点：
                        <span class="areaPlace"></span>
                    </li>
                    <li class="clearfix">
                        <span class="fl is_jiesong" style="display: none;">
                            <input type="checkbox" checked="checked" id="myCheck">
                            <label></label>
                            <label>需要接送我</label>
                        </span>
                        <span class="fl with_confidante" style="display: none;">
                            <input type="checkbox" checked="checked" id="myCheck1">
                            <label></label>
                            <label>对方可携带三两好友</label>
                        </span>
                    </li>
                </ul>
            </div>
        </div>

        <button class="interest" style="display: none;">我感兴趣</button>

        <div class="enrollWrap" style="display:none;">
            <div class="enrollTips">
                邀约留言仅双方可见
            </div>
            <div class="enroll-list">
                <div class="enrollTitle">
                    报名人数(共计<span class="interestedCount"></span>人)
                </div>
                <ul class="enrollUl">
                </ul>
            </div>
        </div>

    </div>

    <!-- 弹框 -->
    <div class="_shade"></div>
    <div class="avatarOperating" style="display: none;">
        <ul>
            <li class="">分享到好友</li>
            <li class="">举报</li>
            <li class="home-cancel">取消</li>
        </ul>
    </div>

    <!-- --------------------------------------------- -->

    <script src="__STATIC__/js-dist/invite-detail.min.js"></script>
    <script src="__STATIC__/js/Global.js"></script>
    <script>
        var Interested = {
            originUserId: "", //自己的user_id
            toUserId: "", //这条邀约发布者的user_id
            detailId: "", //这条邀约的id


            //获取一些页面参数
            getPageData: function () {
                //originUserId我自己的user_id
                if (localStorage.getItem("mUserInfo") && localStorage.getItem("mUserInfo") !== null &&
                    localStorage.getItem("mUserInfo") !== "null") {
                    let mUserInfo = JSON.parse(JSON.parse(localStorage.getItem("mUserInfo")));
                    console.log(mUserInfo)
                    Interested.originUserId = Number(mUserInfo.user_id);
                } else {
                    // Interested.originUserId = 21; //测试用
                    Interested.originUserId = 1; //测试用 自己看自己
                }

                //detailId
                let url = window.location.href;
                if (!(url.indexOf(".html") > -1)) { //没有.html
                    url = url + ".html";
                }
                if (url.indexOf("file:///") > -1) {
                    url = "http://meiliyue.caapa.org/index.php/mobile/invite/detail/id/19.html"; //测试用
                }
                let strTemp = url.split("/detail/id/")[1];
                Interested.detailId = Number(strTemp.substr(0, strTemp.length - 5));

                //ajax邀约详情信息
                Interested.getInviteData();
            },
            getInviteData: function () {
                $.ajax({
                    type: "POST",
                    url: Global.host + "/index.php/Api/invite/detail",
                    data: {
                        id: Interested.detailId
                    },
                    dataType: "json",
                    success: function (result) {
                        console.log(result)

                        if (result.data && result.data !== "") {
                            Interested.toUserId = result.data.user_id;

                            //更新dom
                            Interested.updateDom(result.data);
                        }
                    }
                });
            },
            //根据inviteItem更新Dom
            updateDom: function (data) {
                console.log(data)
                $(".img-box img").attr("src", Global.host + data.head_pic)
                $(".person .name").html(data.nickname)
                if (data.sex == 1) {
                    $(".sexAge").addClass("male");
                } else {
                    $(".sexAge").addClass("female");
                }
                $(".sexAge .age").html(data.age);
                // $(".person .distance .distanceText").html(data.distince)
                $(".inviteDetail .inviteDetail-list li .title").html(data.title)
                $(".inviteDetail .inviteDetail-list li .description").html(data.description)
                //图片
                if (data.image && data.image !== "" && data.image.length !== 0) {
                    let $li = $("<li class='detailImages'></li>");
                    data.image.forEach(function (src, index) {
                        $li.append($(
                            `
                            <img class="inviImg" data-index=${index} src=${Global.host+src}>
                            `
                        ));
                    });

                    $(".descriptionLi").after($li)
                }
                $(".inviteDetail .inviteDetail-list li .payType").html(data.pay);
                $(".inviteDetail .inviteDetail-list li .otherSideSex").html(data.object);
                $(".areaTime .detailTime").html(data.time)
                $(".areaTime .areaPlace").html(data.place)
                //接送，携带好友
                if (data.is_jiesong === 1) {
                    $(".is_jiesong").show();
                }
                if (data.with_confidante === 1) {
                    $(".with_confidante").show();
                }

                //不是自己的邀约
                if (Interested.originUserId !== Interested.toUserId) {
                    $(".interest").show();
                }
                //是自己的邀约
                else {
                    // $(".enroll-list").show();
                    Interested.showInterestedList();
                }

                // Interested.showInterestedList(); //测试用
            },
            getInterested: function () {
                let btn = document.getElementsByClassName("interest")[0];
                let postData = {
                    user_id: Interested.originUserId,
                    invite_id: Interested.detailId
                };
                console.log(postData)
                Global.eleCantClick(btn);
                $.ajax({
                    type: "POST",
                    url: Global.host + "/index.php/Api/invite/enroll",
                    data: postData,
                    dataType: "json",
                    success: function (result) {
                        console.log(result)

                        if (result.msg == "您已感兴趣此邀约") {
                            Global.messageWin("您已感兴趣此邀约");
                        } else {
                            Global.messageWin("成功感兴趣此邀约");
                        }

                        Global.eleCanClick(btn);
                    }
                });
            },
            showInterestedList: function () {
                $.ajax({
                    type: "POST",
                    url: Global.host + "/index.php/Api/invite/getEnroll",
                    data: {
                        invite_id: Interested.detailId
                    },
                    dataType: "json",
                    success: function (result) {
                        console.log(result)
                        if (result.data && result.data !== "" && result.data.length !== 0) {

                            //update list dom
                            let inArr=result.data;

                            $(".interestedCount").html(inArr.length);
                            inArr.forEach(function(item){
                                let headUrl="";
                                if(item.head_pic&&item.head_pic!==""){
                                    headUrl=Global.host+item.head_pic;
                                }else{
                                    headUrl="__STATIC__/images/icon/tx.png";
                                }
                                let $liTemp=$(`
                                    <li class="comments-item" data-toUserId=${item.user_id}>
                                        <div class="comments-avatar">
                                            <div class="comments-avatar-wrap">
                                                <img src="${headUrl}">
                                            </div>
                                            <span class="videoStatus" style="display:none;"></span>
                                        </div>

                                        <div class="comments-text">
                                            <div class="comments-text-item">
                                                <span class="listName">${item.nickname}</span>
                                                <span class="sexAge">
                                                    <i class="sex"></i>
                                                    <span class="age">${item.age}</span>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                `);

                                //视频认证
                                if(item.auth_video_status==2){
                                    $liTemp.find(".videoStatus").show();
                                }
                                //sex
                                if (item.sex == 1) { //男
                                    $liTemp.find(".sexAge").addClass("male");
                                } else {
                                    $liTemp.find(".sexAge").addClass("female");
                                }

                                $(".enrollUl").append($liTemp);
                            });

                            $(".enrollWrap").show();
                        }
                    }
                });
            },
            showFullPic: function (el) {
                let index = $(el).attr("data-index");
                let srcArr = [];
                $(".detailImages img.inviImg").each(function () {
                    // srcArr.unshift($(this).attr("src"));
                    srcArr.push($(this).attr("src"));
                });
                console.log(srcArr)
                let swiper = $.photoBrowser({
                    items: srcArr
                });
                // swiper.open(index);
                swiper.open();
            },
            eventsBind: function () {
                //返回
                $("a.back").click(function () {
                    window.history.back(-1)
                })
                //更多操作
                $("a.operate").click(function () {
                    $("._shade").add($('.avatarOperating')).show()
                })
                //更多操作-取消
                $(".avatarOperating .home-cancel").click(function () {
                    $("._shade").add($('.avatarOperating')).hide()
                })
                //我感兴趣
                $(".interest").click(function () {
                    Interested.getInterested();
                });
                //点击头像看他人的个人主页
                $(".interested .img-box").click(function (event) {
                    event.stopPropagation();
                    let url = "";
                    if (Interested.originUserId !== Interested.toUserId) {
                        url = Global.host + "/index.php/mobile/user/homePage/user_id/" + Interested.originUserId +
                            "/toUserId/" + Interested.toUserId + ".html";
                    } else {
                        url = Global.host + "/index.php/mobile/user/myHomePage.html";
                    }

                    window.location.href = url;
                });
                //点击邀约详情的图片 查看大图
                $(".inviteDetail-list").delegate("img.inviImg", "click", function () {
                    console.log($(this).attr("src"))
                    Interested.showFullPic(this);
                });

                //点击报名的人 进入个人主页
                $(".enrollUl").delegate("li.comments-item","click",function(event){
                    event.stopPropagation();
                    
                    let user_id = Interested.originUserId;
                    let toUserId = $(this).closest(".comments-item").attr("data-toUserId");
                    let url = Global.host + "/index.php/mobile/user/homePage/user_id/" + user_id + "/toUserId/" + toUserId + ".html";
                    console.log(url)
                    window.location.href = url;
                });
            },
            init: function () {
                //获取传来的邀约item信息
                Interested.getPageData()

                Interested.eventsBind()
            }
        }
        $(function () {
            Interested.init()
        })
    </script>
</body>

</html>